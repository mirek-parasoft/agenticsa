name: CMake

on:
  # Triggers the workflow on push or pull request events but only for the master (main) branch.
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master ]

env:
  BUILD_TYPE: Release

jobs:
  build_with_misra:
    runs-on: self-hosted
    continue-on-error: true

    permissions:
      security-events: write
      actions: write
      contents: write
      pages: write
      id-token: write

    steps:
    - uses: actions/checkout@v4

    - name: Create Build Environment
      # Some projects don't allow in-source building, so create a separate build directory
      # We'll use this as our working directory for all subsequent commands
      run: cmake -E make_directory ${{github.workspace}}/build
   
    - name: Configure CMake
      # Use a bash shell so we can use the same syntax for environment variable
      # access regardless of the host operating system
      shell: bash
      working-directory: ${{github.workspace}}
      # Note the current convention is to use the -S and -B options here to specify source 
      # and build directories, but this is only available with CMake 3.13 and higher.  
      # The CMake binaries on the Github Actions machines are (as of this writing) 3.12
      run: cmake -Bbuild -DCMAKE_EXPORT_COMPILE_COMMANDS=1

    - name: Build 
      working-directory: ${{github.workspace}}
      shell: bash
      # Execute the build.  You can specify a specific target with "--target <NAME>"
      run: cmake --build build -- VERBOSE=ON
    
    - name: Static Analysis
      working-directory: ${{github.workspace}}
      shell: bash
      run: |
        set -euo pipefail
        ANALYZER_CMD=("cpptestcli" "-fail" "-compiler" "gcc_13-64" "-config" "MISRA C++ and CERT.properties" "-report" "reports" "-exclude" "*/build/*" "-exclude" "*/*_test.*" "-module" "." "-input" "build/compile_commands.json")  # customize
        MAX_PASSES="${MAX_PASSES:-1}"

        # Ensure we are in a git repo (Codex safety requirement unless you bypass explicitly).
        git rev-parse --is-inside-work-tree >/dev/null  2>&1 || { echo "Not inside a git repository. Exiting."; exit 1; }

        # Ensure clean start
        rm -fr reports
        mkdir -p reports

        # Function to run the analysis
        run_analysis() {
          local out_file="$1"
          # Capture all output; preserve exit code
          set +e
          echo Running analysis with command:
          echo "${ANALYZER_CMD[@]}" 
          "${ANALYZER_CMD[@]}" > "$out_file" 2>&1
          local ec=$?
          set -e
          return "$ec"
        }

        for pass in $(seq 1 "$MAX_PASSES"); do
          echo "== Static analysis pass $pass/$MAX_PASSES ==" >&2

          report="$(mktemp)"
          if run_analysis "$report"; then
            echo "No violations found." >&2
            exit 0
          fi

          echo "Violations detected; invoking Codex..." >&2

          prompt_file="$(mktemp)"
          {
            echo "Please pull the C/C++test violations using the dedicated mcp tool."
            echo "Use available mcp tools to understand violated static analysis rules."
            echo "Your task is to edit the files with problems and fix all violations reported by C/C++test."
            echo "Do not attempt to build, run the project or run C/C++test static analysis!" 
            echo "Make the smallest changes possible to fix the reported violations."
            echo ""
          } > "$prompt_file"

          # Run Codex with write access to the workspace.
          # --full-auto is a convenience preset; you can use --sandbox workspace-write explicitly.
          codex exec --full-auto --sandbox workspace-write "$(cat "$prompt_file")"
          #rm -f "$report" "$prompt_file"
        done

        echo "Violations still present after $MAX_PASSES Codex passes." >&2
        exit 1

    - name: Upload results (SARIF)
      if: always()
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: reports/report.sarif

    # Uploads an archive that includes all report files (.xml, .html, .sarif).
    - name: Archive reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: CpptestReports
        path: reports/*.*